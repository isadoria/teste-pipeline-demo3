# Nome da sua pipeline de seguran√ßa
name: Pipeline de Seguran√ßa DevSecOps

# Quando esta pipeline deve rodar?
# 1. Em todo 'push' (envio de c√≥digo) para o branch 'main'
# 2. Em toda 'pull request' (pedido de merge) para o branch 'main'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Os "trabalhos" (jobs) que a pipeline vai executar
jobs:
  # --- TRABALHO 1: AN√ÅLISE EST√ÅTICA DE C√ìDIGO (SAST) ---
  sast-codeql:
    name: 1. üîç An√°lise de C√≥digo (SAST)
    runs-on: ubuntu-latest # Rodar em uma m√°quina virtual Linux

    # Permiss√µes necess√°rias para o CodeQL
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      # Passo 1: Baixar o seu c√≥digo para a m√°quina virtual
      - name: Baixar o c√≥digo
        uses: actions/checkout@v4

      # Passo 2: Inicializar o CodeQL (o "c√©rebro" da an√°lise)
      - name: Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          # IMPORTANTE: Mude 'javascript' para a linguagem do seu projeto
          # Op√ß√µes: 'csharp', 'go', 'java', 'javascript', 'python', 'ruby', 'swift'
          languages: 'javascript' 
          
      # Passo 3: Rodar a an√°lise do CodeQL
      - name: Rodar An√°lise CodeQL
        uses: github/codeql-action/analyze@v3

  # --- TRABALHO 2: VERIFICA√á√ÉO DE DEPEND√äNCIAS ---
  dependency-review:
    name: 2. Verifica√ß√£o de Depend√™ncias
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write # Permiss√£o para comentar na Pull Request

    steps:
      - name: Baixar o c√≥digo
        uses: actions/checkout@v4

      # Passo 1: Rodar a A√ß√£o de Revis√£o de Depend√™ncia
      # Ela compara as depend√™ncias antes e depois da mudan√ßa
      - name: Revis√£o de Depend√™ncia
        uses: actions/dependency-review-action@v4
        with:
          # Falhar se encontrar uma vulnerabilidade de qualquer severidade
          fail-on-severity: 'high' # Mude para 'critical' se quiser ser menos r√≠gido
          
  # --- TRABALHO 3: VERIFICA√á√ÉO DE SEGREDOS ---
  secret-scan:
    name: 3.  Verifica√ß√£o de Segredos
    runs-on: ubuntu-latest
    
    steps:
      - name: Baixar o c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Puxa todo o hist√≥rico para escanear
          
      # Passo 1: Rodar o "Gitleaks", uma ferramenta popular para achar segredos
      - name: Rodar Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          # Isso diz ao Gitleaks para reportar os erros para o GitHub
          GITLEAKS_REPORTER: "github-pr-comment"
          # Isso √© necess√°rio para que a a√ß√£o possa postar coment√°rios
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
